name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # Build Linux amd64
  build-linux-amd64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang make libcurl4-openssl-dev libsqlite3-dev libsodium-dev libuv1-dev uuid-dev

      - name: Build ZeroClaw
        run: |
          cd zeroclaw
          cargo build --release --lib

      - name: Build CClaw
        run: |
          cd cclaw
          make

      - name: Prepare artifacts
        run: |
          mkdir -p release
          cp cclaw/bin/cclaw release/cclaw-linux-amd64
          chmod +x release/cclaw-linux-amd64

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cclaw-linux-amd64
          path: release/cclaw-linux-amd64

# Build macOS Apple Silicon
build-macos-arm64:
  runs-on: macos-latest
  steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-apple-darwin   # ← 在此声明 target，不需要单独 rustup

    - name: Install dependencies
      run: brew install curl sqlite3 libsodium libuv

    - name: Build ZeroClaw
      run: |
        cd zeroclaw
        cargo build --release --lib --target aarch64-apple-darwin

    - name: Build CClaw
      run: |
        cd cclaw
        # 把 zeroclaw 库路径和 brew 路径显式传给 Makefile
        BREW=$(brew --prefix)
        make \
          ZEROCLAW_LIB=../zeroclaw/target/aarch64-apple-darwin/release \
          EXTRA_CFLAGS="-I$BREW/include" \
          EXTRA_LDFLAGS="-L$BREW/lib"

    - name: Prepare artifacts
      run: |
        mkdir -p release
        cp cclaw/bin/cclaw release/cclaw-macos-arm64
        chmod +x release/cclaw-macos-arm64

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: cclaw-macos-arm64
        path: release/cclaw-macos-arm64

# Build macOS Intel
build-macos-x86_64:
  runs-on: macos-13
  steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install dependencies
      run: brew install curl sqlite3 libsodium libuv

    - name: Build ZeroClaw
      run: |
        cd zeroclaw
        cargo build --release --lib

    - name: Build CClaw
      run: |
        cd cclaw
        BREW=$(brew --prefix)
        make \
          EXTRA_CFLAGS="-I$BREW/include" \
          EXTRA_LDFLAGS="-L$BREW/lib"

    - name: Prepare artifacts
      run: |
        mkdir -p release
        cp cclaw/bin/cclaw release/cclaw-macos-x86_64
        chmod +x release/cclaw-macos-x86_64

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: cclaw-macos-x86_64
        path: release/cclaw-macos-x86_64

# Build Windows x64 — 改成原生 Windows runner
build-windows:
  runs-on: windows-latest
  steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install dependencies (vcpkg)
      run: |
        vcpkg install curl sqlite3 libsodium libuv --triplet x64-windows-static
      env:
        VCPKG_DEFAULT_TRIPLET: x64-windows-static

    - name: Build ZeroClaw
      run: |
        cd zeroclaw
        cargo build --release --lib

    - name: Build CClaw
      run: |
        cd cclaw
        # 根据你的 Makefile 实际情况调整，或者用 cmake
        make ZEROCLAW_LIB=../zeroclaw/target/release \
             VCPKG_ROOT=$env:VCPKG_INSTALLATION_ROOT

    - name: Prepare artifacts
      run: |
        mkdir -p release
        copy cclaw\bin\cclaw.exe release\cclaw-windows.exe

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: cclaw-windows
        path: release/cclaw-windows.exe

  # Create Release - always run even if some builds fail
  create-release:
    needs: [build-linux-amd64, build-macos-arm64, build-macos-x86_64, build-windows]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true
        continue-on-error: true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            artifacts/cclaw-linux-amd64
            artifacts/cclaw-macos-arm64
            artifacts/cclaw-macos-x86_64
            artifacts/cclaw-windows.exe
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
